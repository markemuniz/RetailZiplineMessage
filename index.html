<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Retail Zipline • Daily Message (XLSX/CSV)</title>

<!-- Load a robust XLSX parser (SheetJS) from CDN so XLSX works in Chrome even as file:// -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.20.2/dist/xlsx.full.min.js" integrity="sha384-vbJ0t9YxNEmF0d0/3a6zF1jE4BgbG4KjVoq3Qn2DlsH6u7bZ0l1x4+u1U8eMZt8I" crossorigin="anonymous"></script>

<style>
:root{--bg:#0b0c0e;--panel:#12141a;--muted:#9aa0a6;--text:#f1f3f4;--accent:#00d8ff;--good:#30d158;--bad:#ff453a;--ring:0 0 0 2px rgba(0,216,255,.35)}
*{box-sizing:border-box}
body{margin:0;background:#0b0c0e;color:var(--text);font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial}
header{display:flex;align-items:center;justify-content:space-between;gap:16px;padding:16px 18px;border-bottom:1px solid #1f1f22;background:#0c0c0ee6}
h1{font-size:18px;margin:0;color:var(--accent)}
main{padding:20px;max-width:1200px;margin:0 auto}
.grid{display:grid;grid-template-columns:1.1fr .9fr;gap:18px}
.card{background:var(--panel);border:1px solid #1f1f24;border-radius:14px;overflow:hidden}
.card h2{margin:0;padding:12px 14px;border-bottom:1px solid #22232a;font-size:15px;color:#cfefff}
.card .body{padding:14px}
.row{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;margin:9px 0}
input[type=file]{appearance:none;background:#0f1014;border:1px dashed #2b2b33;border-radius:12px;padding:10px;color:#cbd5e1;width:100%}
input[type=file]:focus{outline:none;box-shadow:var(--ring)}
.pill{display:inline-flex;align-items:center;gap:8px;font-size:12px;padding:6px 10px;border:1px solid #2a2d35;border-radius:999px;background:#0f1116;color:#cbd5e1}
.pill.ok{border-color:#1f6f3a;color:#c4f0d0}
.pill.err{border-color:#6f1f1f;color:#ffc0c0}
.kvs{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
.kv{background:#0d0f14;border:1px solid #23232b;border-radius:12px;padding:10px}
.kv label{display:block;color:var(--muted);font-size:12px;margin-bottom:6px}
.kv input,textarea{width:100%;background:#0b0c10;border:1px solid #23232b;border-radius:10px;color:#fff;padding:10px}
textarea{min-height:72px;resize:vertical}
.btn{cursor:pointer;background:#111318;border:1px solid #24242a;color:#f1f3f4;padding:10px 14px;border-radius:12px;font-weight:600}
.btn.accent{border-color:rgba(0,216,255,.5);box-shadow:0 0 0 2px rgba(0,216,255,.12)}
.bar{display:flex;gap:10px;flex-wrap:wrap}
.hint{color:var(--muted);font-size:12px;margin-top:6px}
.rz{padding:14px}
.rz h3{margin:.4rem 0 .2rem;font-size:14px;color:#a6ecff}
.rz .line{margin:.2rem 0}
.rz ul{margin:.25rem 0 .75rem 1rem}
</style>
</head>
<body>
<header>
  <h1>Retail Zipline • Daily Message Builder</h1>
  <span id="libStatus" class="pill ok">XLSX & CSV supported</span>
</header>

<main>
  <div class="grid">
    <section class="card">
      <h2>1) Upload Reports (XLSX/CSV)</h2>
      <div class="body">
        <div class="row">
          <input id="yesterdayFile" type="file" accept=".xlsx,.csv"/>
          <span id="yStatus" class="pill">Yesterday: N/A</span>
        </div>
        <div class="row">
          <input id="weekFile" type="file" accept=".xlsx,.csv"/>
          <span id="wStatus" class="pill">Week-Prior: N/A</span>
        </div>
        <div class="row">
          <input id="feesFile" type="file" accept=".xlsx,.csv"/>
          <span id="fStatus" class="pill">Fees & Donations: N/A</span>
        </div>
        <div class="hint">If you must work totally offline, export your spreadsheets as CSV — this tool reads CSV locally without any network.</div>

        <h2 style="margin-top:14px">2) Goals & Notes</h2>
        <div class="body" style="padding-top:8px">
          <div class="kvs">
            <div class="kv"><label>Weekly Goal ($)</label><input id="goalWeekly" placeholder="150000"></div>
            <div class="kv"><label>Today’s Goal ($)</label><input id="goalToday" placeholder="45000"></div>
            <div class="kv"><label>Reward Redemptions (count)</label><input id="rewards" placeholder="0"></div>
            <div class="kv"><label>ATV (Last Week) $</label><input id="atvLastWeek" placeholder=""></div>
          </div>
          <div class="kvs" style="margin-top:12px">
            <div class="kv" style="grid-column:1/-1"><label>Team Shoutouts</label><textarea id="shoutouts"></textarea></div>
            <div class="kv" style="grid-column:1/-1"><label>Focus Areas</label><textarea id="focus"></textarea></div>
            <div class="kv" style="grid-column:1/-1"><label>Inventory Updates</label><textarea id="inventory"></textarea></div>
            <div class="kv" style="grid-column:1/-1"><label>Cash Updates</label><textarea id="cash"></textarea></div>
          </div>
          <div class="bar" style="margin-top:10px">
            <button id="generate" class="btn accent">Generate Daily Message</button>
            <button id="copyBtn" class="btn">Copy</button>
            <button id="downloadBtn" class="btn">Download .txt</button>
          </div>
          <div id="error" class="hint" style="color:#ffb4b4;display:none"></div>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>Retail Zipline Message Preview</h2>
      <div id="rz" class="rz"><div class="hint">Upload your files to populate.</div></div>
    </section>
  </div>
</main>

<script>
const $=id=>document.getElementById(id);
const money=n=>isFinite(n)? Number(n).toLocaleString(undefined,{style:'currency',currency:'USD'}):'N/A';
const cleanMoney=s=>Number(String(s||'').replace(/[^0-9.\-]/g,''));
const ord=d=>{const j=d%10,k=d%100; if(j==1&&k!=11) return 'st'; if(j==2&&k!=12) return 'nd'; if(j==3&&k!=13) return 'rd'; return 'th'};
const fullDate=d=>d.toLocaleString(undefined,{month:'long'})+" "+d.getDate()+ord(d.getDate())+", "+d.getFullYear();

function parseCSV(text){
  const rows=[]; let i=0, field='', row=[], inQ=false; const push=()=>{row.push(field); field='';};
  for(; i<text.length; i++){
    const ch=text[i], nx=text[i+1];
    if(inQ){ if(ch==='"'&&nx==='"'){field+='"';i++;} else if(ch==='"'){inQ=false;} else field+=ch; }
    else{ if(ch==='"') inQ=true; else if(ch===',') push(); else if(ch==='\n'){push(); rows.push(row); row=[];}
          else if(ch==='\r'){} else field+=ch; }
  }
  push(); rows.push(row);
  const headers=(rows.shift()||[]).map(h=>h.trim());
  const out=[]; for(const r of rows){ if(r.every(c=>!String(c).trim())) continue; const obj={}; headers.forEach((h,idx)=> obj[h]=(r[idx]||'').trim()); out.push(obj); }
  return out;
}

async function fileToRows(file){
  const name=(file.name||'').toLowerCase();
  if(name.endsWith('.csv')) return parseCSV(await file.text());

  // XLSX via SheetJS
  const data = new Uint8Array(await file.arrayBuffer());
  const wb = XLSX.read(data, {type:"array"});
  // Use the "overview" sheet if present; otherwise first sheet
  const sheetName = wb.SheetNames.find(n => n.toLowerCase()==='overview') || wb.SheetNames[0];
  const ws = wb.Sheets[sheetName];
  // Convert to array of objects (first row as headers)
  const rows = XLSX.utils.sheet_to_json(ws, {defval: "", raw: true});
  // Normalize values to strings
  return rows.map(r => Object.fromEntries(Object.entries(r).map(([k,v])=>[String(k), String(v)])));
}

function parseClosing(rows){
  const out={netSales:NaN,atv:NaN,txns:NaN,deliveries:NaN}; if(!rows||!rows.length) return out;
  const norm=s=>String(s||'').toLowerCase();
  const headers=Object.keys(rows[0]||{});
  const findHeader=(...need)=> headers.find(h=>need.every(n=>norm(h).includes(n)));
  const hNet=findHeader('net','sales');
  const hAtv=findHeader('avg','$','cart')||findHeader('average','order')||findHeader('aov')||findHeader('avg','ticket');
  const hTxn=findHeader('transactions')||findHeader('orders')||findHeader('order','count');
  const hTender=findHeader('tender')||findHeader('payment')||findHeader('type');
  const hDesc=findHeader('desc')||findHeader('memo')||findHeader('note');

  if(hNet){ for(let i=rows.length-1;i>=0;i--){ const n=cleanMoney(rows[i][hNet]); if(isFinite(n)){ out.netSales=n; break; } } }
  if(hAtv){ for(let i=rows.length-1;i>=0;i--){ const n=cleanMoney(rows[i][hAtv]); if(isFinite(n)){ out.atv=n; break; } } }
  if(hTxn){ let maxN=NaN; for(const r of rows){ const n=Number(String(r[hTxn]).replace(/[^0-9]/g,'')); if(isFinite(n)) maxN=isFinite(maxN)?Math.max(maxN,n):n; } out.txns=maxN; }

  // Deliveries = count “Gift Card” rows (Tender/Type or description)
  let deliveries=0;
  if(hTender||hDesc){ for(const r of rows){ const s=(String(hTender? r[hTender]:'')+' '+String(hDesc? r[hDesc]:'')).toLowerCase(); if(/gift\s*card/.test(s)) deliveries++; } }
  if(deliveries>0) out.deliveries=deliveries;

  return out;
}

function parseFees(rows){
  let count=0; const names=new Set(); if(!rows) return {count:0,names:[]};
  const headers=rows.length? Object.keys(rows[0]):[];
  const nameCols=headers.filter(h=>/name|employee|budtender|associate/i.test(h));
  for(const r of rows){
    const line=Object.values(r).join(' ');
    if(/frequent\s*flyer/i.test(line)){
      count++;
      for(const c of nameCols){
        const v=String(r[c]||'').trim();
        if(v && !/frequent|flyer|donation|fees|total/i.test(v)) names.add(v);
      }
    }
  }
  return {count, names:[...names]};
}

const S={y:null,w:null,f:null};
function setPill(id,text,ok){ const el=$(id); el.textContent=text; el.classList.remove('ok','err'); if(ok===true) el.classList.add('ok'); if(ok===false) el.classList.add('err'); }
function hookInput(inputId,key){
  $(inputId).addEventListener('change', async (e)=>{
    const f=e.target.files[0]; if(!f) return; setPill(key+'Status','Reading…');
    try{
      const rows=await fileToRows(f);
      if(!rows){ setPill(key+'Status','No data',false); return; }
      const parsed=(key==='f')?parseFees(rows):parseClosing(rows);
      S[key]=parsed; setPill(key+'Status','Parsed ✓',true);
    }catch(err){
      console.error(err); setPill(key+'Status','Error',false);
      const er=$('error'); er.style.display='block'; er.textContent=err.message||String(err);
    }
  });
}
hookInput('yesterdayFile','y'); hookInput('weekFile','w'); hookInput('feesFile','f');

function render(){
  const y=S.y||{}; const w=S.w||{}; const f=S.f||{count:0,names:[]};
  const d=new Date(); const titleDate=fullDate(d);

  const tx=y.txns; const del=y.deliveries||0;
  const inStore = isFinite(tx-del)? Math.max(0,tx-del) : (isFinite(tx)?tx:NaN);
  const totalTx = (isFinite(inStore)&&isFinite(del)) ? inStore + del : (isFinite(tx)? tx : NaN);
  const totalDel = isFinite(del) ? del : NaN;

  const weekly  = cleanMoney($('goalWeekly').value);
  const tgoal   = cleanMoney($('goalToday').value);
  const rewards = Number($('rewards').value)||0;
  const atvLW   = cleanMoney($('atvLastWeek').value);

  const rz = `
    <h3>Title</h3>
    <div class="line">${titleDate}</div>

    <h3>Sales Recap</h3>
    <ul>
      <li>Yesterday’s Sales: <strong>${money(y.netSales)}</strong></li>
      <li>Same Day Last Week: <strong>${money(w.netSales)}</strong></li>
      <li>Weekly Goal: <strong>${isFinite(weekly)?money(weekly):'N/A'}</strong></li>
      <li>Today’s Goal: <strong>${isFinite(tgoal)?money(tgoal):'N/A'}</strong></li>
    </ul>

    <h3>Performance Metrics</h3>
    <ul>
      <li>Yesterday’s Frequent Flyer Count: <strong>${f.count||0}</strong></li>
      <li>ATV (Yesterday): <strong>${money(y.atv)}</strong></li>
      <li>ATV (Last Week): <strong>${isFinite(atvLW)?money(atvLW):(isFinite(w.atv)?money(w.atv):'N/A')}</strong></li>
      <li>Total Transactions: <strong>${isFinite(totalTx)?totalTx:'N/A'}</strong></li>
      <li>Total Deliveries (Gift Cards Used): <strong>${isFinite(totalDel)?totalDel:'N/A'}</strong></li>
      <li>Reward Redemptions: <strong>${rewards||0}</strong></li>
      <li>Transactions Yesterday:</li>
      <ul>
        <li>In-Store: <strong>${isFinite(inStore)?inStore:'N/A'}</strong></li>
        <li>Delivery: <strong>${isFinite(del)?del:'N/A'}</strong></li>
      </ul>
    </ul>

    <h3>Team Shoutouts</h3>
    <div class="line">${($('shoutouts').value||(f.names&&f.names.length? 'Shoutouts: '+f.names.join(', '):'')) || '<em>—</em>'}</div>
    <h3>Focus Areas</h3>
    <div class="line">${$('focus').value||'<em>—</em>'}</div>
    <h3>Inventory Updates</h3>
    <div class="line">${$('inventory').value||'<em>—</em>'}</div>
    <h3>Cash Updates</h3>
    <div class="line">${$('cash').value||'<em>—</em>'}</div>
  `;
  $('rz').innerHTML = rz;

  const lines=[];
  lines.push(titleDate,'','Sales Recap',
    `Yesterday’s Sales: ${money(y.netSales)}`,
    `Same Day Last Week: ${money(w.netSales)}`,
    `Weekly Goal: ${isFinite(weekly)?money(weekly):'N/A'}`,
    `Today’s Goal: ${isFinite(tgoal)?money(tgoal):'N/A'}`,
    '',
    'Performance Metrics',
    `Yesterday’s Frequent Flyer Count: ${f.count||0}`,
    `ATV (Yesterday): ${money(y.atv)}`,
    `ATV (Last Week): ${isFinite(atvLW)?money(atvLW):(isFinite(w.atv)?money(w.atv):'N/A')}`,
    `Total Transactions: ${isFinite(totalTx)? totalTx:'N/A'}`,
    `Total Deliveries (Gift Cards Used): ${isFinite(totalDel)? totalDel:'N/A'}`,
    `Reward Redemptions: ${rewards||0}`,
    'Transactions Yesterday:',
    `  In-Store: ${isFinite(inStore)?inStore:'N/A'}`,
    `  Delivery: ${isFinite(del)?del:'N/A'}`,
    ''
  );
  if($('shoutouts').value) lines.push('Team Shoutouts: '+$('shoutouts').value);
  if($('focus').value) lines.push('Focus Areas: '+$('focus').value);
  if($('inventory').value) lines.push('Inventory Updates: '+$('inventory').value);
  if($('cash').value) lines.push('Cash Updates: '+$('cash').value);

  return lines.join('\n');
}

$('generate').addEventListener('click',()=>{ try{ window.__rz_text = render(); }catch(err){ const er=$('error'); er.style.display='block'; er.textContent=err.message||String(err); }});
$('copyBtn').addEventListener('click',()=>{ const txt = window.__rz_text || render(); navigator.clipboard.writeText(txt).then(()=>{ $('copyBtn').textContent='Copied!'; setTimeout(()=>{$('copyBtn').textContent='Copy'},1200); }); });
$('downloadBtn').addEventListener('click',()=>{ const txt = window.__rz_text || render(); const blob = new Blob([txt], {type:'text/plain'}); const a=document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='RetailZipline_DailyMessage.txt'; a.click(); });
</script>
</body>
</html>
