<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TTA • Retail Zipline Daily Message (Single-File, Offline-First)</title>
<style>
  :root{--bg:#0b0c0e;--panel:#12141a;--muted:#9aa0a6;--text:#f1f3f4;--accent:#00d8ff;--good:#30d158;--bad:#ff453a;--ring:0 0 0 2px rgba(0,216,255,.35)}
  *{box-sizing:border-box}
  body{margin:0;background:radial-gradient(1200px 800px at 10% -10%,rgba(0,216,255,.08),transparent 55%),radial-gradient(1000px 600px at 100% 10%,rgba(255,77,79,.06),transparent 50%),var(--bg);color:var(--text);font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial}
  header{display:flex;align-items:center;justify-content:space-between;gap:16px;padding:18px 20px;border-bottom:1px solid #1f1f22;position:sticky;top:0;background:#0c0c0ee6;backdrop-filter: blur(6px)}
  .title h1{margin:0;font-size:18px;color:var(--accent)}
  .pill{display:inline-flex;align-items:center;gap:8px;font-size:12px;padding:6px 10px;border:1px solid #2a2d35;border-radius:999px;background:#0f1116;color:#cbd5e1}
  .pill.ok{border-color:#1f6f3a;color:#c4f0d0}
  .pill.err{border-color:#6f1f1f;color:#ffc0c0}
  .banner{display:none;background:#1a2433;border-bottom:1px solid #2a3240;color:#d7faff;padding:10px 16px;font-size:13px}
  .banner.show{display:block}

  main{padding:22px;max-width:1200px;margin:0 auto}
  .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:18px}
  .card{background:var(--panel);border:1px solid #1f1f24;border-radius:16px}
  .card h2{margin:0;padding:14px 16px;border-bottom:1px solid #22232a;font-size:15px;color:#d7faff}
  .card .body{padding:16px}
  .row{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;margin:10px 0}
  input[type=file]{appearance:none;background:#0f1014;border:1px dashed #2b2b33;border-radius:12px;padding:10px;color:#cbd5e1;width:100%}
  input[type=file]:focus{outline:none;box-shadow:var(--ring)}

  .kvs{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  .kv{background:#0d0f14;border:1px solid #23232b;border-radius:12px;padding:10px}
  .kv label{display:block;color:var(--muted);font-size:12px;margin-bottom:6px}
  .kv input{width:100%;background:#0b0c10;border:1px solid #23232b;border-radius:10px;color:#fff;padding:10px}
  .kv input:focus{outline:none;box-shadow:var(--ring)}
  textarea{width:100%;min-height:72px;background:#0b0c10;border:1px solid #23232b;border-radius:12px;color:#fff;padding:10px;resize:vertical}

  .rz{padding:16px}
  .rz h3{margin:.4rem 0 .2rem;font-size:14px;color:#a6ecff}
  .rz .line{margin:.2rem 0}
  .rz ul{margin:.25rem 0 .75rem .9rem}

  .bar{display:flex;gap:10px;flex-wrap:wrap}
  .btn{cursor:pointer;background:#111318;border:1px solid #24242a;color:var(--text);padding:10px 14px;border-radius:12px;font-weight:600}
  .btn.accent{border-color:rgba(0,216,255,.5);box-shadow:0 0 0 2px rgba(0,216,255,.12)}
  .hint{color:var(--muted);font-size:12px;margin-top:6px}
  .test{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:#0c0d12;border:1px solid #22242a;border-radius:12px;padding:12px;color:#e6edf3}
  .green{color:#8be38b}.red{color:#ffb4b4}
</style>

<!-- ===== ultra-light ZIP + XLSX parser (DOMParser + robust regex fallback) ===== -->
<script>
(function(g){"use strict";
  const td = (u)=>new TextDecoder().decode(u);
  const te = (s)=>new TextEncoder().encode(s);
  const u32 = (a,o)=>a[o]|a[o+1]<<8|a[o+2]<<16|a[o+3]<<24;

  function unzipSync(buf){
    const u=new Uint8Array(buf), L=u.length, EOCD=0x06054b50;
    let p=Math.max(0,L-22-65536);
    for(;p<L-3 && (u32(u,p)!==EOCD);p++);
    if(p>=L-3) throw new Error("ZIP: EOCD not found");
    const n = u[p+10]|u[p+11]<<8;
    const ofs = u32(u,p+16);
    let o=ofs, files={};
    for(let i=0;i<n;i++){
      if(u32(u,o)!==0x02014b50) throw new Error("ZIP: Bad CEN");
      const csize=u32(u,o+20), nlen=u[o+32]|u[o+33]<<8, elen=u[o+30]|u[o+31]<<8, clen=u[o+28]|u[o+29]<<8;
      const lhof=u32(u,o+42);
      const name=td(u.subarray(o+46,o+46+nlen));
      const lo=lhof, nl=u[lo+26]|u[lo+27]<<8, el=u[lo+28]|u[lo+29]<<8;
      const dataStart=lo+30+nl+el;
      files[name]={comp:u.subarray(dataStart,dataStart+csize)};
      o+=46+nlen+elen+clen;
    }
    return files;
  }

  function decodeEntities(s){
    return s.replace(/&amp;/g,'&').replace(/&lt;/g,'<').replace(/&gt;/g,'>').replace(/&quot;/g,'"').replace(/&apos;/g,"'");
  }

  function parseSharedStringsXML(xml){
    // combine all <t> inside each <si>
    const sis = xml.split(/<\/si>/i).map(x=>x.split(/<si[^>]*>/i)[1]).filter(Boolean);
    return sis.map(si=>{
      let t='';
      (si.match(/<t[^>]*>[\s\S]*?<\/t>/gi)||[]).forEach(m=>{
        const inner = m.replace(/<\/?t[^>]*>/gi,'');
        t += decodeEntities(inner);
      });
      return t;
    });
  }

  function parseWorksheetXML(xml, shared){
    // Grab rows inside <sheetData>
    const sd = (xml.match(/<sheetData[^>]*>([\s\S]*?)<\/sheetData>/i)||[])[1] || '';
    const rowsXML = sd.split(/<\/row>/i).map(x=>x.split(/<row[^>]*>/i)[1]).filter(Boolean);

    const refToIdx=(r)=>{
      const m=(r||'A1').match(/[A-Z]+|\d+/g) || ['A','1'];
      let col=0; const L=m[0];
      for(let i=0;i<L.length;i++) col = col*26 + (L.charCodeAt(i)-64);
      return [col-1, parseInt(m[1],10)-1];
    };

    let grid={}, maxC=0, maxR=0;
    for(const row of rowsXML){
      const cells = row.match(/<c[^>]*>[\s\S]*?<\/c>/gi) || [];
      for(const cxml of cells){
        const r = ((cxml.match(/ r="([^"]+)"/i)||[])[1]) || 'A1';
        const t = ((cxml.match(/ t="([^"]+)"/i)||[])[1]) || '';
        const vTag = (cxml.match(/<v[^>]*>([\s\S]*?)<\/v>/i)||[])[1];
        const isTag = (cxml.match(/<is[^>]*>([\s\S]*?)<\/is>/i)||[])[1];
        let val = '';
        if(t==='s' && vTag!=null){
          const idx = +vTag;
          val = (shared[idx]||'');
        }else if(t==='inlineStr' && isTag){
          const tparts = isTag.match(/<t[^>]*>([\s\S]*?)<\/t>/gi)||[];
          val = tparts.map(x=>decodeEntities(x.replace(/<\/?t[^>]*>/gi,''))).join('');
        }else if(vTag!=null){
          val = vTag;
        }
        const [x,y]=refToIdx(r);
        grid[x+','+y]=val;
        if(x>maxC) maxC=x; if(y>maxR) maxR=y;
      }
    }
    const aoa=[];
    for(let r=0;r<=maxR;r++){ const row=[]; for(let c=0;c<=maxC;c++){ row.push(grid[c+','+r]||''); } aoa.push(row); }
    const headers=(aoa[0]||[]).map(h=>String(h));
    const out=[];
    for(let i=1;i<aoa.length;i++){
      const row=aoa[i]; if(row.every(x=>String(x).trim()==='')) continue;
      const obj={}; headers.forEach((h,idx)=> obj[h]= row[idx]||''); out.push(obj);
    }
    return out;
  }

  async function parseXLSX(ab){
    const files = unzipSync(ab);
    const wsPath = Object.keys(files).filter(p=>/^xl\/worksheets\/sheet\d+\.xml$/i.test(p)).sort()[0];
    if(!wsPath) throw new Error('XLSX: no worksheet found');

    const dec = new TextDecoder();
    const sstXML = files['xl/sharedStrings.xml'] ? dec.decode(files['xl/sharedStrings.xml'].comp) : '';
    const wsXML  = dec.decode(files[wsPath].comp);

    // Try DOMParser first, then fallback to regex/tokenizer
    try{
      const sstVals = sstXML ? Array.from(new DOMParser().parseFromString(sstXML,'application/xml').getElementsByTagName('si')).map(si=>{
        let t=''; si.querySelectorAll('t').forEach(n=>t+=n.textContent); return t;
      }) : [];
      const doc = new DOMParser().parseFromString(wsXML,'application/xml');
      const rows = Array.from(doc.getElementsByTagName('row'));
      const getVal=(c)=>{
        const t=c.getAttribute('t'), v=c.getElementsByTagName('v')[0], is=c.getElementsByTagName('is')[0];
        if(t==='s' && v) return sstVals[+v.textContent]||'';
        if(t==='inlineStr' && is) return (is.textContent||'');
        if(v) return v.textContent;
        return '';
      };
      const refToIdx=(r)=>{const m=r.match(/[A-Z]+|\d+/g);let col=0;const L=m[0];for(let i=0;i<L.length;i++) col=col*26+(L.charCodeAt(i)-64);return [col-1,parseInt(m[1],10)-1]};
      let maxC=0,maxR=0,grid={};
      rows.forEach(row=>{
        Array.from(row.getElementsByTagName('c')).forEach(c=>{
          const ref=c.getAttribute('r')||'A1';
          const [x,y]=refToIdx(ref);
          grid[x+','+y]=getVal(c);
          if(x>maxC)maxC=x;if(y>maxR)maxR=y;
        });
      });
      const aoa=[];for(let r=0;r<=maxR;r++){const arr=[];for(let c=0;c<=maxC;c++){arr.push(grid[c+','+r]||'')}aoa.push(arr)}
      const headers=(aoa[0]||[]).map(String);
      const out=[];for(let i=1;i<aoa.length;i++){const row=aoa[i];if(row.every(x=>String(x).trim()===''))continue;const obj={};headers.forEach((h,idx)=>obj[h]=row[idx]||'');out.push(obj)};return out;
    }catch(e){
      // Fallback: regex parser (works in file:// and locked contexts)
      const sstVals = sstXML ? parseSharedStringsXML(sstXML) : [];
      return parseWorksheetXML(wsXML, sstVals);
    }
  }

  g.__miniXLSX = { unzipSync, parseXLSX, te };
})(this);
</script>
</head>

<body>
<div id="protoBanner" class="banner">Tip: Opening via <b>http://localhost</b> is fastest, but this build also parses XLSX even as <code>file://</code>.</div>

<header>
  <div class="title"><h1>Retail Zipline • Daily Message Builder</h1></div>
  <div id="libStatus" class="pill ok">Offline: CSV & XLSX supported</div>
</header>

<main>
  <div class="grid">
    <section class="card">
      <h2>1) Upload Reports (CSV/XLSX)</h2>
      <div class="body">
        <div class="row">
          <input id="yesterdayFile" type="file" accept=".csv,.xlsx" />
          <span id="yStatus" class="pill">Yesterday: N/A</span>
        </div>
        <div class="row">
          <input id="weekFile" type="file" accept=".csv,.xlsx" />
          <span id="wStatus" class="pill">Week-Prior: N/A</span>
        </div>
        <div class="row">
          <input id="feesFile" type="file" accept=".csv,.xlsx" />
          <span id="fStatus" class="pill">Fees & Donations: N/A</span>
        </div>
        <div class="hint">Parses <b>CSV</b> and <b>XLSX</b> fully offline. If an older <code>.xls</code> appears, save as <code>.xlsx</code> or CSV.</div>

        <h2 style="margin-top:14px">2) Goals & Notes</h2>
        <div class="body" style="padding-top:8px">
          <div class="kvs">
            <div class="kv"><label>Weekly Goal ($)</label><input id="goalWeekly" placeholder="150000"></div>
            <div class="kv"><label>Today’s Goal ($)</label><input id="goalToday" placeholder="45000"></div>
            <div class="kv"><label>Reward Redemptions (count)</label><input id="rewards" placeholder="0"></div>
            <div class="kv"><label>ATV (Last Week) $</label><input id="atvLastWeek" placeholder=""></div>
          </div>
          <div class="kvs" style="margin-top:12px">
            <div class="kv" style="grid-column:1/-1"><label>Team Shoutouts</label><textarea id="shoutouts" placeholder="Call out any wins or standout performances."></textarea></div>
            <div class="kv" style="grid-column:1/-1"><label>Focus Areas</label><textarea id="focus" placeholder="One or two opportunities for growth or alignment."></textarea></div>
            <div class="kv" style="grid-column:1/-1"><label>Inventory Updates</label><textarea id="inventory" placeholder="Key stock updates or issues."></textarea></div>
            <div class="kv" style="grid-column:1/-1"><label>Cash Updates</label><textarea id="cash" placeholder="Notes / reminders from cash audits or processes."></textarea></div>
          </div>
          <div class="bar" style="margin-top:10px">
            <button id="generate" class="btn accent">Generate Daily Message</button>
            <button id="copyBtn" class="btn">Copy</button>
            <button id="downloadBtn" class="btn">Download .txt</button>
          </div>
          <div id="error" class="hint" style="color:#ffb4b4;display:none"></div>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>Retail Zipline Message Preview</h2>
      <div id="rz" class="rz">
        <div class="hint">Your message will render here in the same structure used in Daily Messages.</div>
      </div>
    </section>
  </div>

  <section class="card" style="margin-top:18px">
    <h2>Parser Tests</h2>
    <div class="body">
      <div class="test" id="testOut">No tests run yet.</div>
      <div class="bar" style="margin-top:10px"><button id="runTests" class="btn">Run Parser Tests</button></div>
      <div class="hint">Tests cover Net Sales, ATV, Transactions, Gift Card deliveries, and Frequent Flyers for CSV + XLSX.</div>
    </div>
  </section>
</main>

<script>
/* ===== helper utils ===== */
const $=id=>document.getElementById(id);
const money=n=>isFinite(n)? Number(n).toLocaleString(undefined,{style:'currency',currency:'USD'}):'N/A';
const cleanMoney=s=>Number(String(s||'').replace(/[^0-9.\-]/g,''));
const ord=d=>{const j=d%10,k=d%100; if(j==1&&k!=11) return 'st'; if(j==2&&k!=12) return 'nd'; if(j==3&&k!=13) return 'rd'; return 'th'};
function fullDate(d){return d.toLocaleString(undefined,{month:'long'})+" "+d.getDate()+ord(d.getDate())+", "+d.getFullYear()}

/* robust CSV parser */
function parseCSV(text){
  const rows=[]; let i=0, field='', row=[], inQ=false; const push=()=>{row.push(field); field='';};
  for(; i<text.length; i++){
    const ch=text[i], nx=text[i+1];
    if(inQ){
      if(ch==='"' && nx==='"'){ field+='"'; i++; }
      else if(ch==='"'){ inQ=false; }
      else field+=ch;
    }else{
      if(ch==='"') inQ=true;
      else if(ch===',') push();
      else if(ch==='\n'){ push(); rows.push(row); row=[]; }
      else if(ch==='\r'){ /* ignore */ }
      else field+=ch;
    }
  }
  push(); rows.push(row);
  const headers=(rows.shift()||[]).map(h=>h.trim());
  const out=[]; for(const r of rows){ if(r.every(c=>!String(c).trim())) continue; const obj={}; headers.forEach((h,idx)=> obj[h]=(r[idx]||'').trim()); out.push(obj); }
  return out;
}

/* file loader */
async function fileToRows(file){
  const name=(file.name||'').toLowerCase();
  if(name.endsWith('.csv')) return parseCSV(await file.text());
  if(name.endsWith('.xlsx')){
    try { const buf=await file.arrayBuffer(); return await __miniXLSX.parseXLSX(buf); }
    catch(err){
      document.getElementById('protoBanner').classList.add('show');
      throw err;
    }
  }
  const er=$('error'); er.style.display='block'; er.textContent='Unsupported file type: '+file.name+' — please upload CSV or XLSX.'; return null;
}

/* business parsers */
function parseClosing(rows){
  const out={netSales:NaN,atv:NaN,txns:NaN,deliveries:NaN}; if(!rows||!rows.length) return out;
  const norm=s=>String(s||'').toLowerCase();
  const headers=Object.keys(rows[0]||{});
  const findHeader=(...need)=> headers.find(h=>need.every(n=>norm(h).includes(n)));
  const hNet=findHeader('net','sales');
  const hAtv=findHeader('avg','$','cart')||findHeader('average','order')||findHeader('aov');
  const hTxn=findHeader('transactions')||findHeader('orders');
  const hTender=findHeader('tender')||findHeader('payment')||findHeader('type');
  const hDesc=findHeader('desc')||findHeader('memo')||findHeader('note');
  if(hNet){ for(let i=rows.length-1;i>=0;i--){ const n=cleanMoney(rows[i][hNet]); if(isFinite(n)){ out.netSales=n; break; } } }
  if(hAtv){ for(let i=rows.length-1;i>=0;i--){ const n=cleanMoney(rows[i][hAtv]); if(isFinite(n)){ out.atv=n; break; } } }
  if(hTxn){ let maxN=NaN; for(const r of rows){ const n=Number(String(r[hTxn]).replace(/[^0-9]/g,'')); if(isFinite(n)) maxN=isFinite(maxN)?Math.max(maxN,n):n; } out.txns=maxN; }
  let deliveries=0; if(hTender||hDesc){ for(const r of rows){ const s=(String(hTender? r[hTender]:'')+' '+String(hDesc? r[hDesc]: '')).toLowerCase(); if(/gift\s*card/.test(s)) deliveries++; } }
  if(deliveries>0) out.deliveries=deliveries;
  return out;
}
function parseFees(rows){
  let count=0; const names=new Set(); if(!rows) return {count:0,names:[]};
  const headers=rows.length? Object.keys(rows[0]):[];
  const nameCols=headers.filter(h=>/name|employee|budtender|associate/i.test(h));
  for(const r of rows){
    const line=Object.values(r).join(' ');
    if(/frequent\s*flyer/i.test(line)){
      count++; for(const c of nameCols){ const v=String(r[c]||'').trim(); if(v && !/frequent|flyer|donation|fees|total/i.test(v)) names.add(v); }
    }
  }
  return {count, names:[...names]};
}

/* UI & compute */
const S={y:null,w:null,f:null};
function setPill(id,text,ok){ const el=$(id); el.textContent=text; el.classList.remove('ok','err'); if(ok===true) el.classList.add('ok'); if(ok===false) el.classList.add('err'); }
function hookInput(inputId,key){
  $(inputId).addEventListener('change', async (e)=>{
    const f=e.target.files[0]; if(!f) return; setPill(key+'Status','Reading…');
    try{
      const rows=await fileToRows(f);
      if(!rows){ setPill(key+'Status','No data',false); return; }
      const parsed=(key==='f')?parseFees(rows):parseClosing(rows);
      S[key]=parsed; setPill(key+'Status','Parsed ✓',true);
    }catch(err){
      console.error(err); setPill(key+'Status','Error',false);
      const er=$('error'); er.style.display='block'; er.textContent=err.message||String(err);
    }
  });
}
hookInput('yesterdayFile','y'); hookInput('weekFile','w'); hookInput('feesFile','f');

function render(){
  const y=S.y||{}; const w=S.w||{}; const f=S.f||{count:0,names:[]};
  const d=new Date(); const titleDate=fullDate(d);
  const tx=y.txns; const del=y.deliveries||0;
  const inStore = isFinite(tx-del)? Math.max(0,tx-del) : (isFinite(tx)?tx:NaN);
  const totalTx = (isFinite(inStore)&&isFinite(del)) ? inStore + del : (isFinite(tx)? tx : NaN);
  const totalDel = isFinite(del) ? del : NaN;

  const weekly = cleanMoney($('goalWeekly').value);
  const tgoal  = cleanMoney($('goalToday').value);
  const rewards= Number($('rewards').value)||0;
  const atvLW  = cleanMoney($('atvLastWeek').value);

  const rz = `
    <h3>Title</h3>
    <div class="line">${titleDate}</div>

    <h3>Sales Recap</h3>
    <ul>
      <li>Yesterday’s Sales: <strong>${money(y.netSales)}</strong></li>
      <li>Same Day Last Week: <strong>${money(w.netSales)}</strong></li>
      <li>Weekly Goal: <strong>${isFinite(weekly)?money(weekly):'N/A'}</strong></li>
      <li>Today’s Goal: <strong>${isFinite(tgoal)?money(tgoal):'N/A'}</strong></li>
    </ul>

    <h3>Performance Metrics</h3>
    <ul>
      <li>Yesterday’s Frequent Flyer Count: <strong>${f.count||0}</strong></li>
      <li>ATV (Yesterday): <strong>${money(y.atv)}</strong></li>
      <li>ATV (Last Week): <strong>${isFinite(atvLW)?money(atvLW): (isFinite(w.atv)? money(w.atv):'N/A')}</strong></li>
      <li>Total Transactions: <strong>${isFinite(totalTx)?totalTx:'N/A'}</strong></li>
      <li>Total Deliveries (Gift Cards Used): <strong>${isFinite(totalDel)?totalDel:'N/A'}</strong></li>
      <li>Reward Redemptions: <strong>${rewards||0}</strong></li>
      <li>Transactions Yesterday:</li>
      <ul>
        <li>In-Store: <strong>${isFinite(inStore)?inStore:'N/A'}</strong></li>
        <li>Delivery: <strong>${isFinite(del)?del:'N/A'}</strong></li>
      </ul>
    </ul>

    <h3>Team Shoutouts</h3>
    <div class="line">${($('shoutouts').value|| (f.names&&f.names.length? 'Shoutouts: '+f.names.join(', '): '')) || '<em>—</em>'}</div>
    <h3>Focus Areas</h3>
    <div class="line">${$('focus').value||'<em>—</em>'}</div>
    <h3>Inventory Updates</h3>
    <div class="line">${$('inventory').value||'<em>—</em>'}</div>
    <h3>Cash Updates</h3>
    <div class="line">${$('cash').value||'<em>—</em>'}</div>
  `;
  $('rz').innerHTML = rz;

  const lines=[];
  lines.push(titleDate,'','Sales Recap',
    `Yesterday’s Sales: ${money(y.netSales)}`,
    `Same Day Last Week: ${money(w.netSales)}`,
    `Weekly Goal: ${isFinite(weekly)?money(weekly):'N/A'}`,
    `Today’s Goal: ${isFinite(tgoal)?money(tgoal):'N/A'}`,
    '',
    'Performance Metrics',
    `Yesterday’s Frequent Flyer Count: ${f.count||0}`,
    `ATV (Yesterday): ${money(y.atv)}`,
    `ATV (Last Week): ${isFinite(atvLW)?money(atvLW): (isFinite(w.atv)? money(w.atv):'N/A')}`,
    `Total Transactions: ${isFinite(totalTx)? totalTx:'N/A'}`,
    `Total Deliveries (Gift Cards Used): ${isFinite(totalDel)? totalDel:'N/A'}`,
    `Reward Redemptions: ${rewards||0}`,
    'Transactions Yesterday:',
    `  In-Store: ${isFinite(inStore)?inStore:'N/A'}`,
    `  Delivery: ${isFinite(del)?del:'N/A'}`,
    ''
  );
  if($('shoutouts').value) lines.push('Team Shoutouts: '+$('shoutouts').value);
  if($('focus').value) lines.push('Focus Areas: '+$('focus').value);
  if($('inventory').value) lines.push('Inventory Updates: '+$('inventory').value);
  if($('cash').value) lines.push('Cash Updates: '+$('cash').value);

  return lines.join('\n');
}

$('generate').addEventListener('click',()=>{ try{ window.__rz_text = render(); }catch(err){ const er=$('error'); er.style.display='block'; er.textContent=err.message||String(err); }});
$('copyBtn').addEventListener('click',()=>{ const txt = window.__rz_text || render(); navigator.clipboard.writeText(txt).then(()=>{ $('copyBtn').textContent='Copied!'; setTimeout(()=>{$('copyBtn').textContent='Copy'},1200); }); });
$('downloadBtn').addEventListener('click',()=>{ const txt = window.__rz_text || render(); const blob = new Blob([txt], {type:'text/plain'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='RetailZipline_DailyMessage.txt'; a.click(); });

/* ===== tests ===== */
document.getElementById('runTests').addEventListener('click',async()=>{
  try{
    // CSV tests
    const closingCSV='Header,Value\nNet Sales,$12345.67\nAvg $/Cart,$42.10\nTransactions,321\nTender,Gift Card\nTender,Cash';
    const feesCSV='Employee,Type,Amount\nAlex,Frequent Flyer,$5\nSam,Donation,$2\nPat,Frequent Flyer,$5';
    const y=parseClosing(parseCSV(closingCSV));
    const f=parseFees(parseCSV(feesCSV));

    // XLSX test: tiny workbook in-memory
    const enc=t=>new TextEncoder().encode(t);
    const sst='<?xml version="1.0"?><sst xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main">'
      +'<si><t>Header</t></si><si><t>Value</t></si>'
      +'<si><t>Net Sales</t></si><si><t>Avg $/Cart</t></si>'
      +'<si><t>Transactions</t></si><si><t>Tender</t></si>'
      +'<si><t>Gift Card</t></si><si><t>Cash</t></si></sst>';
    const sheet1='<?xml version="1.0"?><worksheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main"><sheetData>'
      +'<row r="1"><c r="A1" t="s"><v>0</v></c><c r="B1" t="s"><v>1</v></c></row>'
      +'<row r="2"><c r="A2" t="s"><v>2</v></c><c r="B2">12345.67</c></row>'
      +'<row r="3"><c r="A3" t="s"><v>3</v></c><c r="B3">42.1</c></row>'
      +'<row r="4"><c r="A4" t="s"><v>4</v></c><c r="B4">321</c></row>'
      +'<row r="5"><c r="A5" t="s"><v>5</v></c><c r="B5" t="s"><v>6</v></c></row>'
      +'<row r="6"><c r="A6" t="s"><v>5</v></c><c r="B6" t="s"><v>7</v></c></row>'
      +'</sheetData></worksheet>';
    const wb='<?xml version="1.0"?><workbook xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships"><sheets><sheet name="Sheet1" sheetId="1" r:id="rId1"/></sheets></workbook>';
    const rels='<?xml version="1.0"?><Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships"><Relationship Id="rId1" Target="worksheets/sheet1.xml" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/worksheet"/></Relationships>';
    const contentTypes='<?xml version="1.0"?><Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types"><Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/><Default Extension="xml" ContentType="application/xml"/><Override PartName="/xl/workbook.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet.main+xml"/><Override PartName="/xl/worksheets/sheet1.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml"/><Override PartName="/xl/sharedStrings.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.sharedStrings+xml"/></Types>';
    const relsRoot='<?xml version="1.0"?><Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships"><Relationship Id="rId0" Target="xl/workbook.xml" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument"/></Relationships>';

    function zipSync(map){
      function u16(v){const a=new Uint8Array(2); new DataView(a.buffer).setUint16(0,v,true); return a}
      function u32(v){const a=new Uint8Array(4); new DataView(a.buffer).setUint32(0,v,true); return a}
      function concat(parts){let L=0; for(const p of parts) L+=p.length; const out=new Uint8Array(L); let o=0; for(const p of parts){out.set(p,o); o+=p.length} return out}
      function crc32(d){let c=~0>>>0; const T=new Uint32Array(256).map((_,n)=>{let x=n;for(let i=0;i<8;i++) x = (x&1)? (0xEDB88320 ^ (x>>>1)) : (x>>>1); return x}); for(let i=0;i<d.length;i++) c = (c>>>8) ^ T[(c ^ d[i]) & 255]; return (~c)>>>0}
      let files=[], cd=[], offset=0;
      for(const name in map){
        const data = map[name];
        const n = new TextEncoder().encode(name);
        const crc = crc32(data);
        const lfh = concat([Uint8Array.from([0x50,0x4b,3,4,10,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]), u16(n.length), u16(0), u16(0), n, data]);
        new DataView(lfh.buffer,14,4).setUint32(0,crc,true);
        new DataView(lfh.buffer,18,4).setUint32(0,data.length,true);
        new DataView(lfh.buffer,22,4).setUint32(0,data.length,true);
        files.push(lfh);
        const cen = concat([Uint8Array.from([0x50,0x4b,1,2,0,0,10,0,0,0,0,0,0,0,0,0,0,0,0,0]), u16(n.length), u16(0), u16(0), u16(0), u16(0), u32(crc), u32(data.length), u32(data.length), u32(0), u32(offset), n]);
        cd.push(cen);
        offset += lfh.length;
      }
      const cdBlob = concat(cd);
      const eocd = concat([Uint8Array.from([0x50,0x4b,5,6,0,0]), u16(cd.length), u16(cd.length), u32(cdBlob.length), u32(offset), u16(0)]);
      return concat([...files, cdBlob, eocd]);
    }

    const zip = zipSync({
      '[Content_Types].xml': enc(contentTypes),
      '_rels/.rels': enc(relsRoot),
      'xl/workbook.xml': enc(wb),
      'xl/_rels/workbook.xml.rels': enc(rels),
      'xl/sharedStrings.xml': enc(sst),
      'xl/worksheets/sheet1.xml': enc(sheet1)
    });

    const rowsX = await __miniXLSX.parseXLSX(zip.buffer);
    const yx = parseClosing(rowsX);

    const okCSV = isFinite(y.netSales)&&Math.abs(y.netSales-12345.67)<1e-6
               && isFinite(y.atv)&&Math.abs(y.atv-42.1)<1e-6
               && isFinite(y.txns)&&y.txns===321
               && y.deliveries===1
               && (parseFees(parseCSV(feesCSV)).count===2);

    const okXLSX = isFinite(yx.netSales)&&Math.abs(yx.netSales-12345.67)<1e-6
                && isFinite(yx.atv)&&Math.abs(yx.atv-42.1)<1e-6
                && isFinite(yx.txns)&&yx.txns===321
                && yx.deliveries===1;

    $('testOut').innerHTML = (okCSV && okXLSX)
      ? '<span class="green">All tests passed (CSV + XLSX).</span>'
      : '<span class="red">Tests failed.</span>';
  }catch(e){
    $('testOut').innerHTML = '<span class="red">Test error: '+(e.message||e)+'</span>';
  }
});
</script>
<script>
// show banner when file:// (not required anymore, but nice guidance)
if(location.protocol==='file:'){ document.getElementById('protoBanner').classList.add('show'); }
</script>
</body>
</html>
